---
- connection: local
  hosts: localhost
  sudo: true
  remote_user: douglas
  vars:
    project: owncloud
    ip_address: "192.168.1.{% if environment_tier=='development' %}98{% elif environment_tier=='production' %}9{% endif %}"
    mount_point: /data/www/owncloud_data/
  roles:
    - role: stevenharradine.static-ip
      static_ip_address: "{{ ip_address }}"
    - role: stevenharradine.hostname
    - role: stevenharradine.nfs
      nfs_client_source: "192.168.1.20:/mnt/md0/owncloud-data-{{ environment_tier }}/"
      nfs_client_mount_point: "{{ mount_point }}"
    - role: stevenharradine.owncloud
      owncloud_external_ip: "{{ ip_address }}"
      owncloud_datadirectory: "{{ mount_point }}"
      owncloud_database_password: secure_password
      owncloud_admin_user: douglas
      owncloud_admin_password: password
      owncloud_users:
        - { user: user1, password: password }
        - { user: user2, password: password }
  tasks:
    - name: copy boot.sh
      template:
        src: templates/boot.sh
        dest: /data/boot.sh
        owner: www-data
        group: www-data
        mode: 0755
    - name: create nessasary folders for services to run | cron
      cron:
        name: "create nessasary folders for services to run"
        special_time: reboot
        job: /bin/bash /data/boot.sh
    - name: enable pseudo-forge
      lineinfile:
        dest: /home/douglas/.bashrc
        state: present
        line: "alias reforge='cd /home/douglas/playbook-owncloud/ && git pull && sudo ansible-galaxy install -r dependencies.yml --force && ansible-playbook playbook.yml -i hosts/development'"
        insertafter: EOF
